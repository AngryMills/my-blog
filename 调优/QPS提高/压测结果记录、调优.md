# 压测结果记录、调优





今天收到一个请求，需要把某个服务几个关键接口优化下，把QPS提高到原来的10倍。

一般来说QPS 低多数是中间件的问题，尤其是写入请求的接口。目前用到的中间件有 sqlserver、redis、mongodb。

## 第一次压测：

看下原来的接口QPS和cat接口统计：

机器单台，之前cpu一直没有打满过，想测一下看看机器cpu打满时，中间件的情况。

![1](.\3.png)

![1](.\2.png)

Avg和TP 99.9 的耗时太高了，着重看下耗时慢的地方。

![4](.\4.png)

这里有个写入MongoDB的操作。

把写入操作注释掉之后再压测。（考虑到mongodb的数据可以延迟，采用mq的方式）

## 第二次压测

数据比之前好一些了，机器2台。

![1](.\5.png)

两台8核的机器，cpu打满。发现代码本身也有一些会导致慢的地方。这个DBInterceptor 里边对一个list用的反射，将加密数据解密。(考虑把解密拿到拿到结果后处理)

![1](.\7.png)

数据比之前好一些了，机器12台。

![1](.\6.png)

慢的原因也找到了，sqlserver 慢。

![8](.\8.png)

## 优化方案

尽量减少 sqlserver和mongodb的交互。

解耦非必须的写入操作，查询全部由nosql(redis)代替。

优化代码中耗时长的部分。

具体：

存入 mongdb 改为发mq，由另一个服务接收mq后存入。

读取 sqlserver 改为读取redis，做sqlserver 和redis 双写。

优化 DBInterceptor 。





